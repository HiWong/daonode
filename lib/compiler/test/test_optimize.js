// Generated by CoffeeScript 1.6.2
(function() {
  var Compiler, OptimizationEnv, beautify, compile, compileToCode, fs, il, solve, vari, xexports, _, _ref;

  _ = require("underscore");

  fs = require("fs");

  beautify = require('js-beautify').js_beautify;

  il = require("../interlang");

  _ref = require('../core'), Compiler = _ref.Compiler, OptimizationEnv = _ref.OptimizationEnv;

  solve = function(exp, path) {
    var compiled;

    path = compile(exp, path);
    delete require.cache[require.resolve(path)];
    compiled = require(path);
    return compiled.main();
  };

  compile = function(exp, path) {
    var code, fd;

    code = "_ = require('underscore');\n" + '__slice = [].slice\n' + "solve = require('f:/daonode/lib/compiler/core.js').solve;\n" + "parser = require('f:/daonode/lib/compiler/parser.js');\n" + "solvecore = require('f:/daonode/lib/compiler/solve.js');\n" + "SolverFinish = solvecore.SolverFinish;\n" + "Solver = solvecore.Solver;\n" + "Trail = solvecore.Trail;\n" + "Var = solvecore.Var;\n" + "DummyVar = solvecore.DummyVar;\n\n" + compileToCode(exp) + "\n//exports.main();";
    code = beautify(code, {
      indent_size: 2
    });
    path = path || "f:/daonode/lib/compiler/test/compiled.js";
    fd = fs.openSync(path, 'w');
    fs.writeSync(fd, code);
    fs.closeSync(fd);
    return path;
  };

  compileToCode = function(exp) {
    var compiler, env, f, lamda, v;

    compiler = new Compiler();
    v = il.internallocal('v');
    lamda = il.clamda(v, exp);
    env = new OptimizationEnv(env, {});
    lamda = il.optimize(lamda, env, compiler);
    lamda = lamda.jsify(this, env);
    f = il.assign(il.usernonlocalattr('exports.main'), lamda);
    return f.toCode(compiler);
  };

  vari = function(name) {
    return il.internallocal(name);
  };

  xexports = {};

  exports.Test = {
    "test1": function(test) {
      var x, x2;

      x = il.internallocal('x');
      x2 = il.internallocal('x2');
      test.equal(solve(1), 1);
      test.equal(solve(il.let_([], 1)), 1);
      test.equal(solve(il.assign(x, il.let_([], 1))), 1);
      test.equal(solve(il.begin(il.assign(x, il.let_([], 1)), 2)), 2);
      test.equal(solve(il.let_([], il.assign(x, 1), 1)), 1);
      test.equal(solve(il.let_([x, 1], il.assign(x, il.add(x, 1)), x)), 2);
      test.equal(solve(il.let_([x, 1], il.let_([x2, 2], x2), x)), 1);
      return test.done();
    }
  };

  exports.Test = {
    "test lamda call": function(test) {
      var f, x;

      x = il.internallocal('x');
      f = il.internallocal('f');
      test.equal(solve(il.begin(il.assign(f, il.lamda([x], il.if_(il.eq(x, 0), 0, f.call(il.sub(x, 1))))), f.call(5))), 0);
      return test.done();
    }
  };

  xexports.Test = {
    "test userlocal": function(test) {
      var f, v, x;

      x = il.userlocal('x');
      f = il.internallocal('f');
      v = il.internallocal('v');
      test.equal(solve(il.begin(il.assign(f, il.userlamda([], il.clamda(v, il.assign(x, il.add(x, 1)), x))), 1)), 1);
      return test.done();
    }
  };

}).call(this);

/*
//@ sourceMappingURL=test_optimize.map
*/
