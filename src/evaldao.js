// Generated by CoffeeScript 1.6.2
(function() {
  var dao, deref, done, faildone, _, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  _ = require('underscore');

  dao = exports;

  dao.Env = (function() {
    function Env(bindings, outer) {
      this.bindings = bindings != null ? bindings : {};
      this.outer = outer;
    }

    Env.prototype.extend = function(bindings) {
      return new Environemt(bindings, this);
    };

    Env.prototype.get = function(vari) {
      var env;

      env = this;
      while (env) {
        if (this.bindings.hasOwnProperty(vari.name)) {
          return this.bindings[vari.name];
        }
        env = env.outer;
      }
      return vari;
    };

    Env.prototype.set = function(vari, value) {
      this.bindings[vari.name] = value;
      return this;
    };

    return Env;

  })();

  dao.Bindings = (function() {
    function Bindings(map) {
      this.map = map != null ? map : {};
    }

    Bindings.prototype.clone = function() {
      return new dao.Bindings(_.extend({}, this.map));
    };

    Bindings.prototype.get = function(vari) {
      if (this.map.hasOwnProperty(vari.name)) {
        return this.map[vari.name];
      } else {
        return vari;
      }
    };

    Bindings.prototype.set = function(vari, value) {
      this.map[vari.name] = value;
      return this;
    };

    return Bindings;

  })();

  deref = function(x, env) {
    if (x instanceof dao.Var) {
      return x.deref(env);
    } else {
      return x;
    }
  };

  done = function(v, solver) {
    var result;

    console.log("succeed!");
    result = v.getvalue(solver.env);
    if (result instanceof dao.Atom) {
      return result.item;
    } else {
      return result;
    }
  };

  faildone = function(v, solver) {
    var result;

    console.log("fail!");
    result = v.getvalue(solver.env);
    if (result instanceof dao.Atom) {
      return result.item;
    } else {
      return result;
    }
  };

  dao.element = function(exp) {
    if (_.isNumber(exp)) {
      return dao.number(exp);
    } else if (_.isString(exp)) {
      return dao.string(exp);
    } else if (!_.isObject(exp)) {
      return dao.atom(exp);
    } else if (!exp instanceof dao.Element) {
      return dao.atom(exp);
    } else {
      return exp;
    }
  };

  dao.solve = function(exp, env, cont, failcont) {
    if (env == null) {
      env = new dao.Bindings();
    }
    if (cont == null) {
      cont = done;
    }
    if (failcont == null) {
      failcont = faildone;
    }
    return new dao.Solver(env, failcont).solve(dao.element(exp));
  };

  dao.Solver = (function() {
    function Solver(env, failcont, state) {
      this.env = env;
      this.failcont = failcont;
      this.state = state;
    }

    Solver.prototype.clone = function(update) {
      if (update == null) {
        update = {};
      }
      return new dao.Solver(update.env || this.env.clone(), update.failcont || this.failcont, update.state || this.state);
    };

    Solver.prototype.cont = function(exp, cont) {
      return exp.cont(this, cont || done);
    };

    Solver.prototype.solve = function(exp, cont) {
      cont = this.cont(exp, cont || done);
      return cont(dao.NULL, this);
    };

    return Solver;

  })();

  dao.Element = (function() {
    function Element() {}

    return Element;

  })();

  dao.Var = (function(_super) {
    __extends(Var, _super);

    function Var(name) {
      this.name = name;
    }

    return Var;

  })(dao.Element);

  dao.Atom = (function(_super) {
    __extends(Atom, _super);

    function Atom(item) {
      this.item = item;
    }

    return Atom;

  })(dao.Element);

  dao.Number = (function(_super) {
    __extends(Number, _super);

    function Number() {
      _ref = Number.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    return Number;

  })(dao.Atom);

  dao.String = (function(_super) {
    __extends(String, _super);

    function String() {
      _ref1 = String.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    return String;

  })(dao.Atom);

  dao.Print = (function(_super) {
    __extends(Print, _super);

    function Print() {
      var args;

      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      this.args = args;
    }

    return Print;

  })(dao.Element);

  dao.Succeed = (function(_super) {
    __extends(Succeed, _super);

    function Succeed() {
      _ref2 = Succeed.__super__.constructor.apply(this, arguments);
      return _ref2;
    }

    return Succeed;

  })(dao.Element);

  dao.Fail = (function(_super) {
    __extends(Fail, _super);

    function Fail() {
      _ref3 = Fail.__super__.constructor.apply(this, arguments);
      return _ref3;
    }

    return Fail;

  })(dao.Element);

  dao.And = (function(_super) {
    __extends(And, _super);

    function And(x, y) {
      this.x = x;
      this.y = y;
    }

    return And;

  })(dao.Element);

  dao.Or = (function(_super) {
    __extends(Or, _super);

    function Or(x, y) {
      this.x = x;
      this.y = y;
    }

    return Or;

  })(dao.Element);

  dao.Not = (function(_super) {
    __extends(Not, _super);

    function Not(x) {
      this.x = x;
    }

    return Not;

  })(dao.Element);

  dao.Unify = (function(_super) {
    __extends(Unify, _super);

    function Unify(x, y) {
      this.x = x;
      this.y = y;
    }

    return Unify;

  })(dao.Element);

  dao.Parse = (function(_super) {
    __extends(Parse, _super);

    function Parse(exp, data) {
      this.exp = exp;
      this.data = data;
    }

    return Parse;

  })(dao.Element);

  dao.Char = (function(_super) {
    __extends(Char, _super);

    function Char(x) {
      this.x = x;
    }

    return Char;

  })(dao.Element);

  dao.Apply = (function(_super) {
    __extends(Apply, _super);

    function Apply(caller, args) {
      this.caller = caller;
      this.args = args;
    }

    return Apply;

  })(dao.Element);

  dao.Command = (function(_super) {
    __extends(Command, _super);

    function Command() {
      _ref4 = Command.__super__.constructor.apply(this, arguments);
      return _ref4;
    }

    return Command;

  })(dao.Element);

  dao.Fun = (function(_super) {
    __extends(Fun, _super);

    function Fun(fun) {
      this.fun = fun;
    }

    return Fun;

  })(dao.Command);

  dao.BuiltinFun = (function(_super) {
    __extends(BuiltinFun, _super);

    function BuiltinFun() {
      _ref5 = BuiltinFun.__super__.constructor.apply(this, arguments);
      return _ref5;
    }

    return BuiltinFun;

  })(dao.Fun);

  dao.JSFun = (function(_super) {
    __extends(JSFun, _super);

    function JSFun() {
      _ref6 = JSFun.__super__.constructor.apply(this, arguments);
      return _ref6;
    }

    return JSFun;

  })(dao.Fun);

  dao.Macro = (function(_super) {
    __extends(Macro, _super);

    function Macro(fun) {
      this.fun = fun;
    }

    return Macro;

  })(dao.Command);

  dao.BuiltinMacro = (function(_super) {
    __extends(BuiltinMacro, _super);

    function BuiltinMacro() {
      _ref7 = BuiltinMacro.__super__.constructor.apply(this, arguments);
      return _ref7;
    }

    return BuiltinMacro;

  })(dao.Macro);

  dao.JSMacro = (function(_super) {
    __extends(JSMacro, _super);

    function JSMacro() {
      _ref8 = JSMacro.__super__.constructor.apply(this, arguments);
      return _ref8;
    }

    return JSMacro;

  })(dao.Macro);

  dao.vari = function(name) {
    return new dao.Var(name);
  };

  dao.atom = function(x) {
    return new dao.Atom(x);
  };

  dao.number = function(x) {
    return new dao.Number(x);
  };

  dao.string = function(x) {
    return new dao.String(x);
  };

  dao.print_ = function() {
    var x;

    x = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return (function(func, args, ctor) {
      ctor.prototype = func.prototype;
      var child = new ctor, result = func.apply(child, args);
      return Object(result) === result ? result : child;
    })(dao.Print, x, function(){});
  };

  dao.succeed = new dao.Succeed();

  dao.fail = new dao.Fail();

  dao.and_ = function(x, y) {
    return new dao.And(x, y);
  };

  dao.or_ = function(x, y) {
    return new dao.Or(x, y);
  };

  dao.not_ = function(x, y) {
    return new dao.Not(x);
  };

  dao.unify = function(x, y) {
    return new dao.Unify(x, y);
  };

  dao.parse = function(exp, data) {
    return new dao.Parse(exp, data);
  };

  dao.char = function(x) {
    return new dao.Char(x);
  };

  dao.apply = function(caller, args) {
    return new dao.Apply(caller, args);
  };

  dao.fun = function(fun) {
    return new dao.BuiltinFun(fun);
  };

  dao.jsfun = function(fun) {
    return new dao.JSFun(fun);
  };

  dao.TRUE = dao.atom(true);

  dao.FALSE = dao.atom(false);

  dao.NULL = dao.atom(null);

  dao.Var.prototype.toString = function() {
    return "dao.vari(" + this.name + ")";
  };

  dao.Atom.prototype.toString = function() {
    return "dao.atom(" + this.item + ")";
  };

  dao.Number.prototype.toString = function() {
    return "dao.number(" + this.item + ")";
  };

  dao.String.prototype.toString = function() {
    return "dao.string(" + this.item + ")";
  };

  dao.Succeed.prototype.toString = function() {
    return "dao.succeed";
  };

  dao.Number.prototype.toString = function() {
    return "dao.fail";
  };

  dao.And.prototype.toString = function() {
    return "dao.and_(" + this.x + ", " + this.y + ")";
  };

  dao.Or.prototype.toString = function() {
    return "dao.or_(" + this.x + ", " + this.y + ")";
  };

  dao.Not.prototype.toString = function() {
    return "dao.not_(" + this.x + ")";
  };

  dao.Unify.prototype.toString = function() {
    return "dao.unify_(" + this.x + ", " + this.y + ")";
  };

  dao.Parse.prototype.toString = function() {
    return "dao.parse(" + this.exp + ", " + this.data + ")";
  };

  dao.Char.prototype.toString = function() {
    return "dao.char(" + this.x + ")";
  };

  dao.Apply.prototype.toString = function() {
    return "dao.apply(" + this.caller + ", [" + (this.args.join(', ')) + "])";
  };

  dao.BuiltinFun.prototype.toString = function() {
    return "dao.builtinFunction(" + this.fun;
  };

  dao.JSFun.prototype.toString = function() {
    return "dao.javascriptFunction(" + fun + ")";
  };

  dao.Element.prototype.deref = function(env) {
    return this;
  };

  dao.Var.prototype.deref = function(env) {
    return env.get(this);
  };

  dao.Element.prototype.getvalue = function(env) {
    return this;
  };

  dao.Var.prototype.getvalue = function(env) {
    return this.deref(env);
  };

  dao.Var.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      return cont(_this.deref(solver.env), solver);
    };
  };

  dao.Atom.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      return cont(_this, solver);
    };
  };

  dao.Print.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      console.log.apply(console, _this.args);
      return cont(dao.NULL, solver);
    };
  };

  dao.Succeed.prototype.cont = function(solver, cont) {
    return function(v, solver) {
      return cont(dao.FALSE, solver);
    };
  };

  dao.Fail.prototype.cont = function(solver, cont) {
    return function(v, solver) {
      return solver.failcont(dao.FALSE, solver);
    };
  };

  dao.And.prototype.cont = function(solver, cont) {
    return this.x.cont(solver, this.y.cont(solver, cont));
  };

  dao.Or.prototype.cont = function(solver, cont) {
    var fc, saved_solver,
      _this = this;

    fc = solver.failcont;
    saved_solver = solver.clone();
    solver.failcont = function(v, solver) {
      return _this.y.cont(solver, cont)(v, saved_solver);
    };
    return this.x.cont(solver, (function(v, solver) {
      solver.failcont = fc;
      return cont(v, solver);
    }));
  };

  dao.Not.prototype.cont = function(solver, cont) {
    var fc, saved_solver;

    fc = solver.failcont;
    saved_solver = solver.clone();
    solver.failcont = cont;
    return this.x.cont(solver, function(v, solver) {
      return fc(v, saved_solver);
    });
  };

  dao.Unify.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      var x, y;

      x = deref(_this.x, solver.env);
      y = deref(_this.y, solver.env);
      if (x instanceof dao.Var) {
        solver.env.set(x, y);
        return cont(dao.TRUE, solver);
      } else if (y instanceof dao.Var) {
        solver.env.set(y, x);
        return cont(dao.TRUE, solver);
      } else if (x === y) {
        return cont(dao.TRUE, solver);
      } else {
        return solver.failcont(dao.FALSE, solver);
      }
    };
  };

  dao.Parse.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      var state;

      state = solver.state;
      solver.state = [_this.data, 0];
      return _this.exp.cont(solver, (function(v, solver) {
        solver.state = state;
        return cont(v, solver);
      }))(dao.TRUE, solver);
    };
  };

  dao.Char.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      var c, data, pos, x, _ref9;

      _ref9 = solver.state, data = _ref9[0], pos = _ref9[1];
      if (pos === data.length) {
        return solver.failcont(dao.FALSE, solver);
      }
      x = deref(_this.x, solver.env);
      c = data[pos];
      if (_.isString(x)) {
        if (x === c) {
          solver.state = [data, pos + 1];
          return cont(dao.TRUE, solver);
        } else {
          return solver.failcont(v, solver);
        }
      } else if (x instanceof dao.Var) {
        solver.env.set(x, c);
        return cont(dao.TRUE, solver);
      } else {
        throw new dao.TypeError(_this);
      }
    };
  };

  dao.Apply.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      return _this.caller.apply_cont(solver, cont, _this.args);
    };
  };

  dao.Command.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      return cont(_this, solver);
    };
  };

  dao.BuiltinFun.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      return cont(_this, solver);
    };
  };

  dao.JSFun.prototype.cont = function(solver, cont) {
    var _this = this;

    return function(v, solver) {
      return cont(_this, solver);
    };
  };

  dao.Fun.prototype.apply_cont = function(solver, cont, args) {
    var i, length, params, _i, _ref9,
      _this = this;

    length = args.length;
    params = (function() {
      var _i, _results;

      _results = [];
      for (i = _i = 0; 0 <= length ? _i < length : _i > length; i = 0 <= length ? ++_i : --_i) {
        _results.push(i);
      }
      return _results;
    })();
    cont = (function(cont) {
      return _this.cont(solver, function(caller, solver) {
        return caller.call.apply(caller, [solver, cont].concat(__slice.call(params)));
      });
    })(cont);
    for (i = _i = _ref9 = length - 1; _i >= 0; i = _i += -1) {
      cont = (function(i, cont) {
        return args[i].cont(solver, function(v, solver) {
          params[i] = v;
          return cont(dao.NULL, solver);
        });
      })(i, cont);
    }
    return cont(dao.NULL, solver);
  };

  dao.BuiltinFun.prototype.call = function() {
    var args, cont, solver;

    solver = arguments[0], cont = arguments[1], args = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
    return cont(this.fun.apply(this, args), solver);
  };

  dao.JSFun.prototype.call = function() {
    var arg, args, cont, solver;

    solver = arguments[0], cont = arguments[1], args = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
    args = (function() {
      var _i, _len, _results;

      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        arg = args[_i];
        _results.push(arg.getvalue(solver));
      }
      return _results;
    })();
    args = (function() {
      var _i, _len, _results;

      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        arg = args[_i];
        _results.push(arg instanceof dao.Atom ? arg.item : arg);
      }
      return _results;
    })();
    return cont(dao.element(this.fun.apply(this, args)), solver);
  };

  dao.Macro.call = function() {
    var arg, args, cont, solver;

    solver = arguments[0], cont = arguments[1], args = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
    args = (function() {
      var _i, _len, _results;

      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        arg = args[_i];
        _results.push(dao["eval"](arg));
      }
      return _results;
    })();
    return cont(this.fun.apply(this, args), solver);
  };

}).call(this);

/*
//@ sourceMappingURL=evaldao.map
*/
