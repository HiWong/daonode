// Generated by CoffeeScript 1.6.2
(function() {
  var Apply, Assign, AugmentAssign, Begin, BinaryOperation, CApply, Clamda, ClamdaBody, Code, Deref, Element, Env, Fun, IO, IdCont, If, InternalLocalVar, InternalNonlocalVar, InternalVar, JSFun, Lamda, ListAssign, LocalDecl, MAX_EXTEND_CODE_SIZE, NonlocalDecl, NotImplement, Print, RecursiveClamda, Return, Symbol, Throw, TopBegin, UnaryOperation, UserLamda, UserLocalVar, UserNonlocalVar, UserVar, Var, VirtualOperation, analyze, applySideEffect, augmentAssign, augmentOperators, begin, binary, boolize, codeSize, core, expsEffect, hasOwnProperty, il, insertReturn, isDeclaration, isEmpty, isStatement, jsify, optimize, pure, replace, sideEffect, solve, toString, unary, varattr, vari, vop, vop2, _, _ref, _ref1, _ref10, _ref11, _ref12, _ref13, _ref14, _ref15, _ref16, _ref17, _ref18, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  _ = require("underscore");

  _ref = core = require("./core"), Env = _ref.Env, solve = _ref.solve;

  il = exports;

  exports.NotImplement = NotImplement = (function(_super) {
    __extends(NotImplement, _super);

    function NotImplement(exp, message, stack) {
      this.exp = exp;
      this.message = message != null ? message : '';
      this.stack = stack != null ? stack : this;
    }

    NotImplement.prototype.toString = function() {
      return "" + this.name + " >>> " + this.exp + " " + this.message;
    };

    return NotImplement;

  })(Error);

  toString = function(o) {
    return (o != null ? typeof o.toString === "function" ? o.toString() : void 0 : void 0) || o;
  };

  Element = (function() {
    function Element() {
      this.name = this.toString();
    }

    Element.prototype.call = function() {
      var args;

      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return new Apply(this, args);
    };

    Element.prototype.apply = function(args) {
      return new Apply(this, args);
    };

    Element.prototype.toCode = function(compiler) {
      throw new NotImplement(this, "toCode");
    };

    Object.defineProperty(Element.prototype, '$', {
      get: function() {
        return this.constructor;
      }
    });

    return Element;

  })();

  Var = (function(_super) {
    __extends(Var, _super);

    function Var(name) {
      this.name = name;
    }

    Var.prototype.toString = function() {
      return this.name;
    };

    return Var;

  })(Element);

  UserVar = (function(_super) {
    __extends(UserVar, _super);

    function UserVar() {
      _ref1 = UserVar.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    return UserVar;

  })(Var);

  UserLocalVar = (function(_super) {
    __extends(UserLocalVar, _super);

    function UserLocalVar() {
      _ref2 = UserLocalVar.__super__.constructor.apply(this, arguments);
      return _ref2;
    }

    return UserLocalVar;

  })(UserVar);

  UserNonlocalVar = (function(_super) {
    __extends(UserNonlocalVar, _super);

    function UserNonlocalVar() {
      _ref3 = UserNonlocalVar.__super__.constructor.apply(this, arguments);
      return _ref3;
    }

    return UserNonlocalVar;

  })(UserVar);

  InternalVar = (function(_super) {
    __extends(InternalVar, _super);

    function InternalVar() {
      _ref4 = InternalVar.__super__.constructor.apply(this, arguments);
      return _ref4;
    }

    return InternalVar;

  })(Var);

  InternalLocalVar = (function(_super) {
    __extends(InternalLocalVar, _super);

    function InternalLocalVar() {
      _ref5 = InternalLocalVar.__super__.constructor.apply(this, arguments);
      return _ref5;
    }

    return InternalLocalVar;

  })(InternalVar);

  InternalNonlocalVar = (function(_super) {
    __extends(InternalNonlocalVar, _super);

    function InternalNonlocalVar() {
      _ref6 = InternalNonlocalVar.__super__.constructor.apply(this, arguments);
      return _ref6;
    }

    return InternalNonlocalVar;

  })(InternalVar);

  Symbol = (function(_super) {
    __extends(Symbol, _super);

    function Symbol() {
      _ref7 = Symbol.__super__.constructor.apply(this, arguments);
      return _ref7;
    }

    return Symbol;

  })(Var);

  LocalDecl = (function(_super) {
    __extends(LocalDecl, _super);

    function LocalDecl(vars) {
      this.vars = vars;
      LocalDecl.__super__.constructor.apply(this, arguments);
    }

    LocalDecl.prototype.toString = function() {
      return "localDecl(" + this.vars;
    };

    LocalDecl.prototype.isDeclaration = function() {
      return true;
    };

    return LocalDecl;

  })(Element);

  NonlocalDecl = (function(_super) {
    __extends(NonlocalDecl, _super);

    function NonlocalDecl() {
      _ref8 = NonlocalDecl.__super__.constructor.apply(this, arguments);
      return _ref8;
    }

    NonlocalDecl.prototype.toString = function() {
      return "nonlocalDecl(" + this.vars;
    };

    return NonlocalDecl;

  })(LocalDecl);

  Assign = (function(_super) {
    __extends(Assign, _super);

    function Assign(left, exp) {
      this.left = left;
      this.exp = exp;
      Assign.__super__.constructor.apply(this, arguments);
    }

    Assign.prototype.toString = function() {
      return "" + (toString(this.left)) + " = " + (toString(this.exp));
    };

    return Assign;

  })(Element);

  ListAssign = (function(_super) {
    __extends(ListAssign, _super);

    function ListAssign(lefts, exp) {
      this.lefts = lefts;
      this.exp = exp;
      this.name = this.toString();
    }

    ListAssign.prototype.toString = function() {
      return "" + (toString(this.lefts)) + " = " + (toString(this.exp));
    };

    return ListAssign;

  })(Assign);

  AugmentAssign = (function(_super) {
    __extends(AugmentAssign, _super);

    function AugmentAssign() {
      _ref9 = AugmentAssign.__super__.constructor.apply(this, arguments);
      return _ref9;
    }

    AugmentAssign.prototype.toString = function() {
      return "" + (toString(this.left)) + " " + this.operator + " " + (toString(this.exp));
    };

    return AugmentAssign;

  })(Assign);

  Return = (function(_super) {
    __extends(Return, _super);

    function Return(value) {
      this.value = value;
      Return.__super__.constructor.apply(this, arguments);
    }

    Return.prototype.toString = function() {
      return "return(" + (toString(this.value)) + ")";
    };

    return Return;

  })(Element);

  Throw = (function(_super) {
    __extends(Throw, _super);

    function Throw() {
      _ref10 = Throw.__super__.constructor.apply(this, arguments);
      return _ref10;
    }

    Throw.prototype.toString = function() {
      return "throw(" + (toString(this.value)) + ")";
    };

    return Throw;

  })(Return);

  Begin = (function(_super) {
    __extends(Begin, _super);

    function Begin(exps) {
      this.exps = exps;
      Begin.__super__.constructor.apply(this, arguments);
    }

    Begin.prototype.toString = function() {
      var e;

      return "begin(" + (((function() {
        var _i, _len, _ref11, _results;

        _ref11 = this.exps;
        _results = [];
        for (_i = 0, _len = _ref11.length; _i < _len; _i++) {
          e = _ref11[_i];
          _results.push(toString(e));
        }
        return _results;
      }).call(this)).join(',')) + ")";
    };

    return Begin;

  })(Element);

  TopBegin = (function(_super) {
    __extends(TopBegin, _super);

    function TopBegin() {
      _ref11 = TopBegin.__super__.constructor.apply(this, arguments);
      return _ref11;
    }

    TopBegin.prototype.toString = function() {
      var e;

      return "topbegin(" + (((function() {
        var _i, _len, _ref12, _results;

        _ref12 = this.exps;
        _results = [];
        for (_i = 0, _len = _ref12.length; _i < _len; _i++) {
          e = _ref12[_i];
          _results.push(toString(e));
        }
        return _results;
      }).call(this)).join(',')) + ")";
    };

    return TopBegin;

  })(Begin);

  Print = (function(_super) {
    __extends(Print, _super);

    function Print() {
      _ref12 = Print.__super__.constructor.apply(this, arguments);
      return _ref12;
    }

    Print.prototype.toString = function() {
      var e;

      return "print(" + (((function() {
        var _i, _len, _ref13, _results;

        _ref13 = this.exps;
        _results = [];
        for (_i = 0, _len = _ref13.length; _i < _len; _i++) {
          e = _ref13[_i];
          _results.push(toString(e));
        }
        return _results;
      }).call(this)).join(',')) + ")";
    };

    return Print;

  })(Begin);

  Lamda = (function(_super) {
    __extends(Lamda, _super);

    function Lamda(params, body) {
      this.params = params;
      this.body = body;
      Lamda.__super__.constructor.apply(this, arguments);
    }

    Lamda.prototype.toString = function() {
      var e;

      return "(" + (((function() {
        var _i, _len, _ref13, _results;

        _ref13 = this.params;
        _results = [];
        for (_i = 0, _len = _ref13.length; _i < _len; _i++) {
          e = _ref13[_i];
          _results.push(toString(e));
        }
        return _results;
      }).call(this)).join(', ')) + " -> " + (toString(this.body)) + ")";
    };

    Lamda.prototype.call = function() {
      var args;

      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return new Apply(this, args);
    };

    Lamda.prototype.apply = function(args) {
      return new Apply(this, args);
    };

    return Lamda;

  })(Element);

  UserLamda = (function(_super) {
    __extends(UserLamda, _super);

    function UserLamda() {
      _ref13 = UserLamda.__super__.constructor.apply(this, arguments);
      return _ref13;
    }

    return UserLamda;

  })(Lamda);

  Clamda = (function(_super) {
    __extends(Clamda, _super);

    function Clamda(v, body) {
      this.v = v;
      this.body = body;
      this.name = this.toString();
    }

    Clamda.prototype.toString = function() {
      return "(" + (toString(this.v)) + " -> " + (toString(this.body)) + ")";
    };

    Clamda.prototype.call = function(value) {
      var result;

      result = replace(this.body, this.v.name, value);
      if (result.constructor === TopBegin) {
        result.constructor = Begin;
      }
      return result;
    };

    return Clamda;

  })(Lamda);

  RecursiveClamda = (function(_super) {
    __extends(RecursiveClamda, _super);

    function RecursiveClamda() {
      _ref14 = RecursiveClamda.__super__.constructor.apply(this, arguments);
      return _ref14;
    }

    RecursiveClamda.prototype.call = function(value) {
      return new CApply(this, value);
    };

    return RecursiveClamda;

  })(Clamda);

  ClamdaBody = (function(_super) {
    __extends(ClamdaBody, _super);

    function ClamdaBody() {
      _ref15 = ClamdaBody.__super__.constructor.apply(this, arguments);
      return _ref15;
    }

    ClamdaBody.prototype.toString = function() {
      return "{" + this.v + ": " + (toString(this.body)) + "}";
    };

    ClamdaBody.prototype.call = function(value) {
      return new Error("How is it happened to call with ClamdaBody? " + this);
    };

    return ClamdaBody;

  })(Clamda);

  IdCont = (function(_super) {
    __extends(IdCont, _super);

    function IdCont() {
      _ref16 = IdCont.__super__.constructor.apply(this, arguments);
      return _ref16;
    }

    return IdCont;

  })(Clamda);

  JSFun = (function(_super) {
    __extends(JSFun, _super);

    function JSFun(fun) {
      this.fun = fun;
      JSFun.__super__.constructor.apply(this, arguments);
    }

    JSFun.prototype.toString = function() {
      return "jsfun(" + this.fun + ")";
    };

    JSFun.prototype.apply = function(args) {
      return new Apply(this, args);
    };

    return JSFun;

  })(Element);

  exports.VirtualOperation = VirtualOperation = (function(_super) {
    __extends(VirtualOperation, _super);

    function VirtualOperation(args) {
      this.args = args;
      VirtualOperation.__super__.constructor.apply(this, arguments);
    }

    VirtualOperation.prototype.toString = function() {
      var arg;

      return "vop_" + this._name + "(" + (((function() {
        var _i, _len, _ref17, _results;

        _ref17 = this.args;
        _results = [];
        for (_i = 0, _len = _ref17.length; _i < _len; _i++) {
          arg = _ref17[_i];
          _results.push(toString(arg));
        }
        return _results;
      }).call(this)).join(', ')) + ")";
    };

    return VirtualOperation;

  })(Element);

  BinaryOperation = (function(_super) {
    __extends(BinaryOperation, _super);

    function BinaryOperation() {
      _ref17 = BinaryOperation.__super__.constructor.apply(this, arguments);
      return _ref17;
    }

    BinaryOperation.prototype.toString = function() {
      return "" + (toString(this.args[0])) + this.symbol + (toString(this.args[1]));
    };

    BinaryOperation.prototype._effect = false;

    return BinaryOperation;

  })(VirtualOperation);

  UnaryOperation = (function(_super) {
    __extends(UnaryOperation, _super);

    function UnaryOperation() {
      _ref18 = UnaryOperation.__super__.constructor.apply(this, arguments);
      return _ref18;
    }

    UnaryOperation.prototype.toString = function() {
      return "" + this.symbol + (toString(this.args[0]));
    };

    UnaryOperation.prototype._effect = false;

    return UnaryOperation;

  })(BinaryOperation);

  Fun = (function(_super) {
    __extends(Fun, _super);

    function Fun(func) {
      this.func = func;
      Fun.__super__.constructor.apply(this, arguments);
    }

    Fun.prototype.toString = function() {
      return "fun(" + this.func + ")";
    };

    Fun.prototype.apply = function(args) {
      return new Apply(this, args);
    };

    return Fun;

  })(Element);

  Apply = (function(_super) {
    __extends(Apply, _super);

    function Apply(caller, args) {
      this.caller = caller;
      this.args = args;
      Apply.__super__.constructor.apply(this, arguments);
    }

    Apply.prototype.toString = function() {
      var arg;

      return "(" + (toString(this.caller)) + ")(" + (((function() {
        var _i, _len, _ref19, _results;

        _ref19 = this.args;
        _results = [];
        for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
          arg = _ref19[_i];
          _results.push(toString(arg));
        }
        return _results;
      }).call(this)).join(', ')) + ")";
    };

    return Apply;

  })(Element);

  CApply = (function(_super) {
    __extends(CApply, _super);

    function CApply(cont, value) {
      this.caller = cont;
      this.args = [value];
      this.name = this.toString();
    }

    return CApply;

  })(Apply);

  Deref = (function(_super) {
    __extends(Deref, _super);

    function Deref(exp) {
      this.exp = exp;
      Deref.__super__.constructor.apply(this, arguments);
    }

    Deref.prototype.toString = function() {
      return "deref(" + (toString(this.exp)) + ")";
    };

    return Deref;

  })(Element);

  Code = (function(_super) {
    __extends(Code, _super);

    function Code(string) {
      this.string = string;
      Code.__super__.constructor.apply(this, arguments);
    }

    Code.prototype.toString = function() {
      return "code(" + this.string + ")";
    };

    return Code;

  })(Element);

  If = (function(_super) {
    __extends(If, _super);

    function If(test, then_, else_) {
      this.test = test;
      this.then_ = then_;
      this.else_ = else_;
      If.__super__.constructor.apply(this, arguments);
    }

    If.prototype.toString = function() {
      return "if_(" + (toString(this.test)) + ", " + (toString(this.then_)) + ", " + (toString(this.else_)) + ")";
    };

    return If;

  })(Element);

  replace = function(exp, param, value) {
    var exp_replace;

    exp_replace = exp != null ? exp.replace : void 0;
    if (exp_replace) {
      return exp_replace.call(exp, param, value);
    } else {
      return exp;
    }
  };

  Var.prototype.replace = function(param, value) {
    if (this.name === param) {
      return value;
    } else {
      return this;
    }
  };

  Assign.prototype.replace = function(param, value) {
    return new this.constructor(this.left, replace(this.exp, param, value));
  };

  ListAssign.prototype.replace = function(param, value) {
    return new this.constructor(this.lefts, replace(this.exp, param, value));
  };

  If.prototype.replace = function(param, value) {
    return new If(replace(this.test, param, value), replace(this.then_, param, value), replace(this.else_, param, value));
  };

  Return.prototype.replace = function(param, value) {
    return new this.constructor(replace(this.value, param, value));
  };

  Lamda.prototype.replace = function(param, value) {
    return this;
  };

  Clamda.prototype.replace = function(param, value) {
    return this;
  };

  ClamdaBody.prototype.replace = function(param, value) {
    throw Error("#replace param with value in clamda should do before optimize Clamda");
  };

  IdCont.prototype.replace = function(param, value) {
    return this;
  };

  Apply.prototype.replace = function(param, value) {
    var a;

    return new Apply(replace(this.caller, param, value), (function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(replace(a, param, value));
      }
      return _results;
    }).call(this));
  };

  VirtualOperation.prototype.replace = function(param, value) {
    var a;

    return new this.constructor((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(replace(a, param, value));
      }
      return _results;
    }).call(this));
  };

  Begin.prototype.replace = function(param, value) {
    var exp;

    return new this.constructor((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.exps;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        exp = _ref19[_i];
        _results.push(replace(exp, param, value));
      }
      return _results;
    }).call(this));
  };

  Deref.prototype.replace = function(param, value) {
    return new Deref(value.replace(this.exp, param));
  };

  Code.prototype.replace = function(param, value) {
    return this;
  };

  JSFun.prototype.replace = function(param, value) {
    return new JSFun(replace(this.fun, param, value));
  };

  optimize = function(exp, env, compiler) {
    var exp_optimize;

    exp_optimize = exp != null ? exp.optimize : void 0;
    if (exp_optimize) {
      return exp_optimize.call(exp, env, compiler);
    } else {
      return exp;
    }
  };

  Var.prototype.optimize = function(env, compiler) {
    return env.lookup(this);
  };

  Assign.prototype.optimize = function(env, compiler) {
    var a, left;

    left = this.left;
    if (left instanceof VirtualOperation) {
      left = new left.constructor((function() {
        var _i, _len, _ref19, _results;

        _ref19 = left.args;
        _results = [];
        for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
          a = _ref19[_i];
          _results.push(compiler.optimize(a, env));
        }
        return _results;
      })());
    } else if (left instanceof UserLocalVar) {
      env.userlocals()[left] = left;
    } else if (left instanceof UserNonlocalVar) {
      env.usernonlocals()[left] = left;
    } else if (left instanceof InternalLocalVar) {
      env.locals()[left] = left;
    } else if (left instanceof InternalNonlocalVar) {
      env.nonlocals()[left] = left;
    }
    return new this.constructor(left, compiler.optimize(this.exp, env));
  };

  LocalDecl.prototype.optimize = function(env, compiler) {
    var vari, _i, _len, _ref19;

    _ref19 = this.vars;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      vari = _ref19[_i];
      if (vari instanceof UserVar) {
        env.userlocals()[vari] = vari;
      } else {
        env.locals()[vari] = vari;
      }
    }
    return null;
  };

  NonlocalDecl.prototype.optimize = function(env, compiler) {
    var vari, _i, _len, _ref19;

    _ref19 = this.vars;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      vari = _ref19[_i];
      if (vari instanceof UserVar) {
        env.usernonlocals()[vari] = vari;
      } else {
        env.nonlocals()[vari] = vari;
      }
    }
    return null;
  };

  ListAssign.prototype.optimize = function(env, compiler) {
    var a, left, lefts, _i, _len, _ref19;

    lefts = [];
    _ref19 = this.lefts;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      left = _ref19[_i];
      if (left instanceof UserNonlocalVar) {
        env.usernonlocals()[left] = left;
      } else if (left instanceof UserLocalVar) {
        env.userlocals()[left] = left;
      } else if (left instanceof InternalNonlocalVar) {
        env.nonlocals()[left] = left;
      } else {
        env.locals()[left] = left;
      }
      if (left instanceof VirtualOperation) {
        lefts.push(new left.constructor((function() {
          var _j, _len1, _ref20, _results;

          _ref20 = left.args;
          _results = [];
          for (_j = 0, _len1 = _ref20.length; _j < _len1; _j++) {
            a = _ref20[_j];
            _results.push(compiler.optimize(a, env));
          }
          return _results;
        })()));
      } else {
        lefts.push(left);
      }
    }
    return new this.constructor(lefts, compiler.optimize(this.exp, env));
  };

  If.prototype.optimize = function(env, compiler) {
    var else_, test, test_bool, then_;

    test = optimize(this.test, env, compiler);
    test_bool = boolize(test);
    if (test_bool === true) {
      then_ = optimize(this.then_, env, compiler);
      if (then_ instanceof If && then_.test === test) {
        then_ = then_.then_;
      }
      return then_;
    } else if (test_bool === false) {
      else_ = optimize(this.else_, env, compiler);
      if (else_ instanceof If && else_.test === test) {
        else_ = else_.else_;
      }
      return else_;
    } else {
      then_ = optimize(this.then_, env, compiler);
      else_ = optimize(this.else_, env, compiler);
      if (then_ instanceof If && then_.test === test) {
        then_ = then_.then_;
      }
      if (else_ instanceof If && else_.test === test) {
        else_ = else_.else_;
      }
      return new If(test, then_, else_);
    }
  };

  Return.prototype.optimize = function(env, compiler) {
    return new Return(compiler.optimize(this.value, env));
  };

  Throw.prototype.optimize = function(env, compiler) {
    return new Throw(compiler.optimize(this.value, env));
  };

  Lamda.prototype.optimize = function(env, compiler) {
    var bindings, locals, nonlocals, p, result, _i, _len, _ref19;

    bindings = {};
    _ref19 = this.params;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      p = _ref19[_i];
      bindings[p] = p;
    }
    locals = {};
    nonlocals = {};
    env = env.extendBindings(bindings, {
      _locals: locals,
      _nonlocals: nonlocals
    });
    result = new Lamda(this.params, compiler.optimize(this.body, env));
    result.locals = locals;
    result.nonlocals = nonlocals;
    return result;
  };

  UserLamda.prototype.optimize = function(env, compiler) {
    var bindings, locals, nonlocals, p, result, _i, _len, _ref19;

    bindings = {};
    _ref19 = this.params;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      p = _ref19[_i];
      bindings[p] = p;
    }
    locals = {};
    nonlocals = {};
    env = env.extendBindings(bindings, {
      _userlocals: locals,
      _usernonlocals: nonlocals
    });
    result = new UserLamda(this.params, compiler.optimize(this.body, env));
    result.locals = locals;
    result.nonlocals = nonlocals;
    return result;
  };

  Clamda.prototype.optimize = function(env, compiler) {
    var body, locals, nonlocals, result;

    locals = {};
    nonlocals = {};
    body = compiler.optimize(this.body, env.extend(this.v, this.v, {
      _locals: locals,
      _nonlocals: nonlocals
    }));
    result = il.clamda(this.v, body);
    result.locals = locals;
    result.nonlocals = nonlocals;
    return result;
  };

  ClamdaBody.prototype.optimize = function(env, compiler) {
    return new ClamdaBody(this.v, compiler.optimize(this.body, env.extend(this.v, this.v)));
  };

  IdCont.prototype.optimize = function(env, compiler) {
    return this;
  };

  Apply.prototype.optimize = function(env, compiler) {
    var a, args, caller;

    caller = compiler.optimize(this.caller, env);
    args = (function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(compiler.optimize(a, env));
      }
      return _results;
    }).call(this);
    return (typeof caller.optimizeApply === "function" ? caller.optimizeApply(args, env, compiler) : void 0) || new Apply(caller, args);
  };

  VirtualOperation.prototype.optimize = function(env, compiler) {
    var a, args, bool, myBoolize;

    args = (function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(compiler.optimize(a, env));
      }
      return _results;
    }).call(this);
    myBoolize = function(memo, x) {
      if (memo === void 0) {
        return void 0;
      } else if (boolize(x) === void 0) {
        return void 0;
      } else {
        return true;
      }
    };
    bool = _.reduce(args, myBoolize, true);
    if (bool && this.func) {
      return this.func.apply(null, args);
    } else {
      return new this.constructor(args);
    }
  };

  Begin.prototype.optimize = function(env, compiler) {
    var e, exp, exps, result, waitPop, _i, _len, _ref19;

    result = [];
    waitPop = false;
    _ref19 = this.exps;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      exp = _ref19[_i];
      e = compiler.optimize(exp, env);
      if (isDeclaration(e)) {
        continue;
      }
      if (waitPop) {
        result.pop();
      }
      if (e instanceof Begin) {
        exps = e.exps;
        result = result.concat(exps);
        waitPop = sideEffect(result[-1]) === il.PURE;
      } else {
        result.push(e);
        waitPop = sideEffect(e) === il.PURE;
      }
    }
    if (result.length > 1) {
      return new this.constructor(result);
    } else {
      return result[0];
    }
  };

  Deref.prototype.optimize = function(env, compiler) {
    var exp;

    exp = this.exp;
    if (_.isString(exp)) {
      return exp;
    } else if (_.isNumber(exp)) {
      return exp;
    } else {
      return new Deref(compiler.optimize(exp, env));
    }
  };

  Code.prototype.optimize = function(env, compiler) {
    return this;
  };

  JSFun.prototype.optimize = function(env, compiler) {
    return new JSFun(compiler.optimize(this.fun, env));
  };

  Var.prototype.optimizeApply = function(args, env, compiler) {
    return new Apply(this, args);
  };

  Apply.prototype.optimizeApply = function(args, env, compiler) {
    return new Apply(this, args);
  };

  Lamda.prototype.optimizeApply = function(args, env, compiler) {
    var exps, i, p, params, paramsLength;

    params = this.params;
    paramsLength = params.length;
    if (paramsLength === 0) {
      return compiler.optimize(body, env);
    }
    exps = (function() {
      var _i, _len, _results;

      _results = [];
      for (i = _i = 0, _len = params.length; _i < _len; i = ++_i) {
        p = params[i];
        _results.push(il.assign(p, args[i]));
      }
      return _results;
    })();
    exps.push(this.body);
    return new Apply(new Lamda([], compiler.optimize(il.topbegin.apply(il, exps), env)), []);
  };

  Clamda.prototype.optimizeApply = function(args, env, compiler) {
    return il.begin(il.assign(this.v, compiler.optimize(args[0], env)), this.body).optimize(env, compiler);
  };

  RecursiveClamda.prototype.optimizeApply = function(args, env, compiler) {
    return il.begin(il.assign(this.v, compiler.optimize(args[0], env)), this.body).optimize(env, compiler);
  };

  IdCont.prototype.optimizeApply = function(args, env, compiler) {
    return compiler.optimize(args[0], env);
  };

  JSFun.prototype.optimizeApply = function(args, env, compiler) {
    var f, t;

    f = this.fun;
    t = typeof f;
    if (t === 'function') {
      return new Apply(f, args);
    } else if (t === 'string') {
      return new Apply(il.fun(f), args);
    } else {
      return f.apply(args).optimize(env, compiler);
    }
  };

  MAX_EXTEND_CODE_SIZE = 10;

  hasOwnProperty = Object.prototype.hasOwnProperty;

  isEmpty = function(obj) {
    var key;

    for (key in obj) {
      if (hasOwnProperty.call(obj, key)) {
        return false;
      }
    }
    return true;
  };

  analyze = function(exp, compiler, refMap) {
    var exp_analyze;

    exp_analyze = exp != null ? exp.analyze : void 0;
    if (exp_analyze) {
      return exp_analyze.call(exp, compiler, refMap);
    }
  };

  Var.prototype.analyze = function(compiler, refMap) {
    if (hasOwnProperty.call(refMap, this)) {
      return refMap[this]++;
    } else {
      return refMap[this] = 1;
    }
  };

  Assign.prototype.analyze = function(compiler, refMap) {
    return analyze(this.exp, compiler, refMap);
  };

  If.prototype.analyze = function(compiler, refMap) {
    return analyze(this.test, compiler, refMap) + analyze(this.then_, compiler, refMap) + analyze(this.else_, compiler, refMap);
  };

  Begin.prototype.analyze = function(compiler, refMap) {
    var e, _i, _len, _ref19, _results;

    _ref19 = this.exps;
    _results = [];
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      e = _ref19[_i];
      _results.push(analyze(e, compiler, refMap));
    }
    return _results;
  };

  Return.prototype.analyze = function(compiler, refMap) {
    return analyze(this.value, compiler, refMap);
  };

  Apply.prototype.analyze = function(compiler, refMap) {
    var e, _i, _len, _ref19, _results;

    analyze(this.caller, compiler, refMap);
    _ref19 = this.args;
    _results = [];
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      e = _ref19[_i];
      _results.push(analyze(e, compiler, refMap));
    }
    return _results;
  };

  VirtualOperation.prototype.analyze = function(compiler, refMap) {
    var e, _i, _len, _ref19, _results;

    _ref19 = this.args;
    _results = [];
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      e = _ref19[_i];
      _results.push(analyze(e, compiler, refMap));
    }
    return _results;
  };

  CApply.prototype.analyze = function(compiler, refMap) {
    analyze(this.cont, compiler, refMap);
    return analyze(this.value, compiler, refMap);
  };

  Lamda.prototype.analyze = function(compiler, refMap) {
    var childMap, i, x, _results;

    childMap = this.refMap = {};
    analyze(this.body, compiler, childMap);
    _results = [];
    for (x in childMap) {
      i = childMap[x];
      if (__indexOf.call(this.params, x) < 0) {
        if (hasOwnProperty.call(refMap, x)) {
          _results.push(refMap[x] += i);
        } else {
          _results.push(refMap[x] = i);
        }
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  Clamda.prototype.analyze = function(compiler, refMap) {
    var childMap, i, x, _results;

    childMap = this.refMap = {};
    analyze(this.body, compiler, childMap);
    _results = [];
    for (x in childMap) {
      i = childMap[x];
      if (x !== this.v.name) {
        if (hasOwnProperty.call(refMap, x)) {
          _results.push(refMap[x] += i);
        } else {
          _results.push(refMap[x] = i);
        }
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  ClamdaBody.prototype.analyze = function(compiler, refMap) {
    var childMap, i, x, _results;

    childMap = this.refMap = {};
    analyze(this.body, compiler, childMap);
    _results = [];
    for (x in childMap) {
      i = childMap[x];
      if (x !== this.v.name) {
        if (hasOwnProperty.call(refMap, x)) {
          _results.push(refMap[x] += i);
        } else {
          _results.push(refMap[x] = i);
        }
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  codeSize = function(exp) {
    var exp_codeSize;

    exp_codeSize = exp != null ? exp.codeSize : void 0;
    if (exp_codeSize) {
      return exp_codeSize.call(exp);
    } else {
      return 1;
    }
  };

  Var.prototype.codeSize = function() {
    return 1;
  };

  Return.prototype.codeSize = function() {
    return codeSize(this.value) + 1;
  };

  If.prototype.codeSize = function() {
    return sideEffeft(this.test) + codeSize(this.then_) + codeSize(this.else_) + 1;
  };

  Begin.prototype.codeSize = function() {
    return _.reduce(this.exps, (function(memo, e) {
      return memo + codeSize(e);
    }), 0);
  };

  VirtualOperation.prototype.codeSize = function() {
    return 1;
  };

  Lamda.prototype.codeSize = function() {
    return codeSize(this.body) + 2;
  };

  Clamda.prototype.codeSize = function() {
    return codeSize(this.body) + 1;
  };

  ClamdaBody.prototype.codeSize = function() {
    return codeSize(this.body);
  };

  Apply.prototype.codeSize = function() {
    return _.reduce(this.args, (function(memo, e) {
      return memo + codeSize(e);
    }), codeSize(this.caller));
  };

  CApply.prototype.codeSize = function() {
    return codeSize(this.caller.body) + codeSize(this.args[0]) + 2;
  };

  boolize = function(exp) {
    var exp_boolize;

    exp_boolize = exp != null ? exp.boolize : void 0;
    if (exp_boolize) {
      return exp_boolize.call(exp);
    } else {
      return !!exp;
    }
  };

  Var.prototype.boolize = function() {
    return void 0;
  };

  Return.prototype.boolize = function() {
    return boolize(this.value);
  };

  If.prototype.boolize = function() {
    var b;

    b = boolize(this.test);
    if (b === void 0) {
      void 0;
    }
    if (b === true) {
      return boolize(this.then_);
    } else {
      return boolize(this.else_);
    }
  };

  Begin.prototype.boolize = function() {
    var exps;

    exps = this.exps;
    return boolize(exps[exps.length - 1]);
  };

  VirtualOperation.prototype.boolize = function() {
    var a, _i, _len, _ref19, _ref20;

    _ref19 = this.args;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      a = _ref19[_i];
      if (boolize(a) === void 0) {
        return void 0;
      }
    }
    return !!((_ref20 = this.func) != null ? _ref20.apply(null, this.args) : void 0) || void 0;
  };

  Lamda.prototype.boolize = function() {
    return true;
  };

  Clamda.prototype.boolize = function() {
    return true;
  };

  ClamdaBody.prototype.boolize = function() {
    return boolize(this.body);
  };

  Apply.prototype.boolize = function() {
    var a, caller, _i, _len, _ref19, _ref20;

    caller = this.caller;
    if (caller instanceof Lamda || caller instanceof Clamda) {
      return boolize(caller.body);
    }
    if (caller instanceof Var) {
      return void 0;
    }
    _ref19 = this.args;
    for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
      a = _ref19[_i];
      if (boolize(a) === void 0) {
        return void 0;
      }
    }
    return !!((_ref20 = caller.func) != null ? _ref20.apply(null, this.args) : void 0) || void 0;
  };

  CApply.prototype.boolize = function() {
    return boolize(this.caller.body);
  };

  isDeclaration = function(exp) {
    var exp_isDeclaration;

    exp_isDeclaration = exp != null ? exp.isDeclaration : void 0;
    if (exp_isDeclaration) {
      return exp_isDeclaration.call(exp);
    } else {
      return false;
    }
  };

  il.PURE = 0;

  il.EFFECT = 1;

  il.IO = 2;

  il.pure = pure = function(exp) {
    exp._effect = il.PURE;
    return exp;
  };

  il.effect = function(exp) {
    exp._effect = il.EFFECT;
    return exp;
  };

  il.io = function(exp) {
    exp._effect = il.IO;
    return exp;
  };

  sideEffect = function(exp) {
    var exp_effect;

    exp_effect = exp != null ? exp.sideEffect : void 0;
    if (exp_effect) {
      return exp_effect.call(exp);
    } else {
      return il.EFFECT;
    }
  };

  expsEffect = function(exps) {
    var e, eff, effect, _i, _len;

    effect = il.PURE;
    for (_i = 0, _len = exps.length; _i < _len; _i++) {
      e = exps[_i];
      eff = sideEffect(e);
      if (eff === il.IO) {
        return il.IO;
      }
      if (eff === il.EFFECT) {
        effect = eff;
      }
    }
    return effect;
  };

  Var.prototype.sideEffect = function() {
    return il.PURE;
  };

  NonlocalDecl.prototype.sideEffect = function() {
    return il.PURE;
  };

  Return.prototype.sideEffect = function() {
    return sideEffect(this.value);
  };

  If.prototype.sideEffect = function() {
    return expsEffect([this.test, this.then_, this.else_]);
  };

  Begin.prototype.sideEffect = function() {
    return expsEffect(this.exps);
  };

  Lamda.prototype.sideEffect = function() {
    return il.PURE;
  };

  Apply.prototype.sideEffect = function() {
    return Math.max(applySideEffect(this.caller), expsEffect(this.args));
  };

  VirtualOperation.prototype.sideEffect = function() {
    return Math.max(this._effect, expsEffect(this.args));
  };

  CApply.prototype.sideEffect = function() {
    return Math.max(applySideEffect(this.caller), sideEffect(this.args[0]));
  };

  applySideEffect = function(exp) {
    var exp_applySideEffect;

    exp_applySideEffect = exp != null ? exp.applySideEffect : void 0;
    if (exp_applySideEffect) {
      return exp_applySideEffect.call(exp);
    } else {
      return il.IO;
    }
  };

  Element.prototype.applySideEffect = function() {
    throw new NotImplement(this, 'applySideEffect');
  };

  Var.prototype.applySideEffect = function() {
    return il.IO;
  };

  Apply.prototype.applySideEffect = function() {
    return il.IO;
  };

  VirtualOperation.prototype.applySideEffect = function() {
    return il.IO;
  };

  Fun.prototype.applySideEffect = function() {
    if (this._effect != null) {
      return this._effect;
    } else {
      return il.IO;
    }
  };

  JSFun.prototype.applySideEffect = function() {
    if (this._effect != null) {
      return this._effect;
    } else {
      return il.IO;
    }
  };

  Lamda.prototype.applySideEffect = function() {
    if (this._effect != null) {
      return this._effect;
    } else {
      return sideEffect(this.body);
    }
  };

  Clamda.prototype.applySideEffect = function() {
    if (this._effect != null) {
      return this._effect;
    } else {
      return sideEffect(this.body);
    }
  };

  IO = function(exp) {
    var exp_IO;

    exp_IO = exp != null ? exp.IO : void 0;
    if (exp_IO) {
      return exp_IO.call(exp);
    } else {
      return false;
    }
  };

  jsify = function(exp) {
    var exp_jsify;

    exp_jsify = exp != null ? exp.jsify : void 0;
    if (exp_jsify) {
      return exp_jsify.call(exp);
    } else {
      return exp;
    }
  };

  Assign.prototype.jsify = function() {
    var assign, e, exp, exps, length;

    exp = this.exp;
    if (exp instanceof Begin) {
      exps = exp.exps;
      length = exps.length;
      assign = new this.constructor(this.left, jsify(exps[length - 1])).jsify();
      exps = (function() {
        var _i, _len, _ref19, _results;

        _ref19 = exps.slice(0, length - 1);
        _results = [];
        for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
          e = _ref19[_i];
          _results.push(jsify(e));
        }
        return _results;
      })();
      return il.begin.apply(il, exps.concat([assign]));
    } else if (exp instanceof ClamdaBody) {
      return new this.constructor(this.left, exp.body).jsify();
    } else if (exp instanceof If) {
      return new If(exp.test, new this.constructor(this.left, exp.then_).jsify(), new this.constructor(this.left, exp.else_).jsify());
    } else {
      return new this.constructor(this.left, jsify(exp));
    }
  };

  ListAssign.prototype.jsify = function() {
    var exp, i, lefts;

    lefts = this.lefts;
    exp = this.exp;
    return il.begin.apply(il, (function() {
      var _i, _ref19, _results;

      _results = [];
      for (i = _i = 0, _ref19 = lefts.length; 0 <= _ref19 ? _i < _ref19 : _i > _ref19; i = 0 <= _ref19 ? ++_i : --_i) {
        _results.push(new Assign(lefts[i], il.index(exp, i)));
      }
      return _results;
    })());
  };

  Return.prototype.jsify = function() {
    return new this.constructor(jsify(this.value));
  };

  If.prototype.jsify = function() {
    return new If(this.test, jsify(this.then_), jsify(this.else_));
  };

  Begin.prototype.jsify = function() {
    var e, exps, length, result, _i, _len;

    exps = this.exps;
    length = exps.length;
    if (length === 0 || length === 1) {
      throw new Error("begin should have at least one exp");
    }
    result = [];
    for (_i = 0, _len = exps.length; _i < _len; _i++) {
      e = exps[_i];
      result.push(jsify(e));
    }
    return new this.constructor(result);
  };

  Lamda.prototype.jsify = function() {
    var body, k, locals, locals1, nonlocals;

    locals = [];
    nonlocals = this.nonlocals;
    locals1 = this.locals;
    for (k in locals1) {
      if (!hasOwnProperty.call(nonlocals, k) && __indexOf.call(this.params, k) < 0) {
        locals.push(il.symbol(k));
      }
    }
    body = jsify(this.body);
    body = insertReturn(body);
    if (locals.length > 0) {
      return new Lamda(this.params, il.topbegin(il.vardecl.apply(il, locals), body));
    } else {
      return new Lamda(this.params, body);
    }
  };

  Clamda.prototype.jsify = function() {
    var body, k, locals, locals1, nonlocals;

    locals = [];
    nonlocals = this.nonlocals;
    locals1 = this.locals;
    for (k in locals1) {
      if (!hasOwnProperty.call(nonlocals, k) && k.name !== this.v.name) {
        locals.push(il.symbol(k));
      }
    }
    body = jsify(this.body);
    body = insertReturn(body);
    if (locals.length > 0) {
      return il.clamda(this.v, il.vardecl.apply(il, locals), body);
    } else {
      return il.clamda(this.v, body);
    }
  };

  ClamdaBody.prototype.jsify = function() {
    return jsify(this.body);
  };

  Apply.prototype.jsify = function() {
    var a, args;

    args = (function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(jsify(a));
      }
      return _results;
    }).call(this);
    return new this.constructor(jsify(this.caller), args);
  };

  CApply.prototype.jsify = function() {
    return new CApply(this.caller.jsify(), jsify(this.args[0]));
  };

  VirtualOperation.prototype.jsify = function() {
    var a, args;

    args = (function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(jsify(a));
      }
      return _results;
    }).call(this);
    return new this.constructor(args);
  };

  insertReturn = function(exp) {
    var exp_insertReturn;

    exp_insertReturn = exp != null ? exp.insertReturn : void 0;
    if (exp_insertReturn) {
      return exp_insertReturn.call(exp);
    } else {
      return new Return(exp);
    }
  };

  Assign.prototype.insertReturn = function() {
    return il.begin(this, il["return"](this.left));
  };

  Return.prototype.insertReturn = function() {
    return this;
  };

  If.prototype.insertReturn = function() {
    if (this.isStatement()) {
      return new If(this.test, insertReturn(this.then_), insertReturn(this.else_));
    } else {
      return new Return(this);
    }
  };

  Begin.prototype.insertReturn = function() {
    var exps, last, length;

    exps = this.exps;
    length = exps.length;
    last = insertReturn(exps[length - 1]);
    return begin.apply(null, [this.constructor].concat(__slice.call(__slice.call(exps.slice(0, length - 1)).concat([last]))));
  };

  Lamda.prototype.toCode = function(compiler) {
    var a;

    compiler.parent = this;
    return "function(" + (((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.params;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        a = _ref19[_i];
        _results.push(a.name);
      }
      return _results;
    }).call(this)).join(', ')) + "){" + (compiler.toCode(this.body)) + "}";
  };

  Clamda.prototype.toCode = function(compiler) {
    compiler.parent = this;
    return "function(" + this.v.name + "){" + (compiler.toCode(this.body)) + "}";
  };

  Fun.prototype.toCode = function(compiler) {
    return this.func.toString();
  };

  Return.prototype.toCode = function(compiler) {
    return "return " + (compiler.toCode(this.value)) + ";";
  };

  Throw.prototype.toCode = function(compiler) {
    return "throw " + (compiler.toCode(this.value)) + ";";
  };

  Var.prototype.toCode = function(compiler) {
    return this.name;
  };

  NonlocalDecl.prototype.toCode = function(compiler) {
    return '';
  };

  Assign.prototype.toCode = function(compiler) {
    return "" + (compiler.toCode(this.left)) + " = " + (compiler.toCode(this.exp));
  };

  AugmentAssign.prototype.toCode = function(compiler) {
    return "" + (compiler.toCode(this.left)) + " " + this.operator + " " + (compiler.toCode(this.exp));
  };

  If.prototype.toCode = function(compiler) {
    var else_;

    compiler.parent = this;
    else_ = this.else_;
    if (this.isStatement()) {
      if (else_ === void 0) {
        return "if (" + (compiler.toCode(this.test)) + ") " + (compiler.toCode(this.then_));
      } else {
        return "if (" + (compiler.toCode(this.test)) + ") " + (compiler.toCode(this.then_)) + " else " + (compiler.toCode(this.else_));
      }
    } else {
      return "(" + (compiler.toCode(this.test)) + ") ? (" + (compiler.toCode(this.then_)) + ") : (" + (compiler.toCode(this.else_)) + ")";
    }
  };

  Apply.prototype.toCode = function(compiler) {
    var arg;

    return "(" + (compiler.toCode(this.caller)) + ")(" + (((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.args;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        arg = _ref19[_i];
        _results.push(compiler.toCode(arg));
      }
      return _results;
    }).call(this)).join(', ')) + ")";
  };

  CApply.prototype.toCode = function(compiler) {
    return "(" + (compiler.toCode(this.caller)) + ")(" + (compiler.toCode(this.args[0])) + ")";
  };

  Begin.prototype.toCode = function(compiler) {
    var exp;

    compiler.parent = this;
    return "{" + (((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.exps;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        exp = _ref19[_i];
        _results.push(compiler.toCode(exp));
      }
      return _results;
    }).call(this)).join('; ')) + "}";
  };

  TopBegin.prototype.toCode = function(compiler) {
    var exp;

    compiler.parent = this;
    return "" + (((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.exps;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        exp = _ref19[_i];
        _results.push(compiler.toCode(exp));
      }
      return _results;
    }).call(this)).join('; '));
  };

  Print.prototype.toCode = function(compiler) {
    var exp;

    return "console.log(" + (((function() {
      var _i, _len, _ref19, _results;

      _ref19 = this.exps;
      _results = [];
      for (_i = 0, _len = _ref19.length; _i < _len; _i++) {
        exp = _ref19[_i];
        _results.push(compiler.toCode(exp));
      }
      return _results;
    }).call(this)).join(', ')) + ")";
  };

  Deref.prototype.toCode = function(compiler) {
    return "solver.trail.deref(" + (compiler.toCode(this.exp)) + ")";
  };

  Code.prototype.toCode = function(compiler) {
    return this.string;
  };

  JSFun.prototype.toCode = function(compiler) {
    if (_.isString(this.fun)) {
      return this.fun;
    } else {
      return compiler.toCode(this.fun);
    }
  };

  isStatement = function(exp) {
    var exp_isStatement;

    exp_isStatement = exp != null ? exp.isStatement : void 0;
    if (exp_isStatement) {
      return exp_isStatement.call(exp);
    } else {
      return false;
    }
  };

  If.prototype.isStatement = function() {
    return isStatement(this.then_) || isStatement(this.else_);
  };

  Begin.prototype.isStatement = function() {
    return true;
  };

  Return.prototype.isStatement = function() {
    return true;
  };

  Assign.prototype.isStatement = function() {
    return true;
  };

  vari = function(klass, name) {
    return new klass(name);
  };

  il.userlocal = function(name) {
    return new UserLocalVar(name);
  };

  il.usernonlocal = function(name) {
    return new UserNonlocalVar(name);
  };

  il.internallocal = function(name) {
    return new InternalLocalVar(name);
  };

  il.internalnonlocal = function(name) {
    return new InternalNonlocalVar(name);
  };

  il.symbol = function(name) {
    return new Symbol(name);
  };

  varattr = function(klass, name) {
    var i, length, names, result, _i;

    if (name == null) {
      return new klass(name);
    }
    if (name instanceof Var) {
      name = name.name;
    }
    names = name.split('.');
    length = names.length;
    result = new klass(names[0]);
    for (i = _i = 1; 1 <= length ? _i < length : _i > length; i = 1 <= length ? ++_i : --_i) {
      result = il.attr(result, il.symbol(names[i]));
    }
    return result;
  };

  il.usernonlocalattr = function(name) {
    return varattr(UserNonlocalVar, name);
  };

  il.assign = function(left, exp) {
    return new Assign(left, exp);
  };

  il.userlocalassign = function(left, exp) {
    if (left instanceof Var) {
      left = left.name;
    }
    return new Assign(il.userlocal(left), exp);
  };

  il.usernonlocalassign = function(left, exp) {
    if (left instanceof Var) {
      left = left.name;
    }
    return new Assign(il.userlocal(left), exp);
  };

  il.internallocalassign = function(left, exp) {
    if (left instanceof Var) {
      left = left.name;
    }
    return new Assign(il.internalnonlocal(left), exp);
  };

  il.internalnonlocalassign = function(left, exp) {
    if (left instanceof Var) {
      left = left.name;
    }
    return new Assign(il.internallocal(left), exp);
  };

  il.if_ = function(test, then_, else_) {
    return new If(test, then_, else_);
  };

  il.deref = function(exp) {
    return new Deref(exp);
  };

  begin = function() {
    var e, exps, klass, length, result, _i, _len;

    klass = arguments[0], exps = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    length = exps.length;
    if (length === 0) {
      throw new Error("begin should have at least one exp");
    }
    result = [];
    for (_i = 0, _len = exps.length; _i < _len; _i++) {
      e = exps[_i];
      if (e instanceof Begin) {
        result = result.concat(e.exps);
      } else {
        result.push(e);
      }
    }
    if (result.length === 1) {
      return result[0];
    } else {
      return new klass(result);
    }
  };

  il.begin = function() {
    var exps;

    exps = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return begin.apply(null, [Begin].concat(__slice.call(exps)));
  };

  il.topbegin = function() {
    var exps;

    exps = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return begin.apply(null, [TopBegin].concat(__slice.call(exps)));
  };

  il.print = function() {
    var exps;

    exps = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return new Print(exps);
  };

  il["return"] = function(value) {
    return new Return(value);
  };

  il["throw"] = function(value) {
    return new Throw(value);
  };

  il.lamda = function() {
    var body, params;

    params = arguments[0], body = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return new Lamda(params, il.topbegin.apply(il, body));
  };

  il.userlamda = function() {
    var body, params;

    params = arguments[0], body = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return new UserLamda(params, il.topbegin.apply(il, body));
  };

  il.clamda = function() {
    var body, v;

    v = arguments[0], body = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return new Clamda(v, il.topbegin.apply(il, body));
  };

  il.recclamda = function() {
    var body, v;

    v = arguments[0], body = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return new RecursiveClamda(v, il.topbegin.apply(il, body));
  };

  il.clamdabody = function(v, body) {
    return new ClamdaBody(v, body);
  };

  il.code = function(string) {
    return new Code(string);
  };

  il.jsfun = function(fun) {
    return new JSFun(fun);
  };

  binary = function(symbol, func, effect) {
    var Binary, _ref19;

    if (effect == null) {
      effect = il.PURE;
    }
    Binary = (function(_super) {
      __extends(Binary, _super);

      function Binary() {
        _ref19 = Binary.__super__.constructor.apply(this, arguments);
        return _ref19;
      }

      Binary.prototype.symbol = symbol;

      Binary.prototype.toCode = function(compiler) {
        var args;

        args = this.args;
        return "" + (compiler.toCode(args[0])) + " " + symbol + " " + (compiler.toCode(args[1]));
      };

      func;

      func;

      Binary.prototype._effect = effect;

      return Binary;

    })(BinaryOperation);
    return function(x, y) {
      return new Binary([x, y]);
    };
  };

  unary = function(symbol, func, effect) {
    var Unary, _ref19;

    if (effect == null) {
      effect = il.PURE;
    }
    Unary = (function(_super) {
      __extends(Unary, _super);

      function Unary() {
        _ref19 = Unary.__super__.constructor.apply(this, arguments);
        return _ref19;
      }

      Unary.prototype.symbol = symbol;

      func;

      func;

      Unary.prototype._effect = effect;

      Unary.prototype.toCode = function(compiler) {
        return "" + symbol + (compiler.toCode(this.args[0]));
      };

      return Unary;

    })(UnaryOperation);
    return function(x) {
      return new Unary([x]);
    };
  };

  il.eq = binary("===", function(x, y) {
    return x === y;
  });

  il.ne = binary("!==", function(x, y) {
    return x !== y;
  });

  il.lt = binary("<", function(x, y) {
    return x < y;
  });

  il.le = binary("<=", function(x, y) {
    return x <= y;
  });

  il.gt = binary(">", function(x, y) {
    return x > y;
  });

  il.ge = binary(">=", function(x, y) {
    return x >= y;
  });

  il.add = binary("+", function(x, y) {
    return x + y;
  });

  il.sub = binary("-", function(x, y) {
    return x - y;
  });

  il.mul = binary("*", function(x, y) {
    return x * y;
  });

  il.div = binary("/", function(x, y) {
    return x / y;
  });

  il.mod = binary("%", function(x, y) {
    return x % y;
  });

  il.and_ = binary("&&", function(x, y) {
    return x && y;
  });

  il.or_ = binary("||", function(x, y) {
    return x || y;
  });

  il.bitand = binary("&", function(x, y) {
    return x & y;
  });

  il.bitor = binary("|", function(x, y) {
    return x | y;
  });

  il.bitxor = binary("^", function(x, y) {
    return x ^ y;
  });

  il.lshift = binary("<<", function(x, y) {
    return x << y;
  });

  il.rshift = binary(">>", function(x, y) {
    return x >> y;
  });

  augmentAssign = function(operator, func) {
    var AugAssign, _ref19;

    AugAssign = (function(_super) {
      __extends(AugAssign, _super);

      function AugAssign() {
        _ref19 = AugAssign.__super__.constructor.apply(this, arguments);
        return _ref19;
      }

      AugAssign.prototype.operator = operator;

      AugAssign.prototype.func = func;

      return AugAssign;

    })(AugmentAssign);
    return function(vari, exp) {
      return new AugAssign(vari, exp);
    };
  };

  il.addassign = augmentAssign("+=", function(x, y) {
    return x + y;
  });

  il.subassign = augmentAssign("-=", function(x, y) {
    return x - y;
  });

  il.mulassign = augmentAssign("*=", function(x, y) {
    return x * y;
  });

  il.divassign = augmentAssign("/=", function(x, y) {
    return x / y;
  });

  il.modassign = augmentAssign("%=", function(x, y) {
    return x % y;
  });

  il.andassign = augmentAssign("&&=", function(x, y) {
    return x && y;
  });

  il.orassign = augmentAssign("||=", function(x, y) {
    return x || y;
  });

  il.bitandassign = augmentAssign("&=", function(x, y) {
    return x & y;
  });

  il.bitorassign = augmentAssign("|=", function(x, y) {
    return x | y;
  });

  il.bitxorassign = augmentAssign("^=", function(x, y) {
    return x ^ y;
  });

  il.lshiftassign = augmentAssign("<<=", function(x, y) {
    return x << y;
  });

  il.rshiftassign = augmentAssign(">>=", function(x, y) {
    return x >> y;
  });

  il.listassign = function() {
    var exp, lefts, _i;

    lefts = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), exp = arguments[_i++];
    return new ListAssign(lefts, exp);
  };

  il.not_ = unary("!", function(x) {
    return !x;
  });

  il.neg = unary("-", function(x) {
    return -x;
  });

  il.bitnot = unary("~", function(x) {
    return ~x;
  });

  il.inc = il.effect(unary("++"), (function(x) {
    return x + 1;
  }), il.EFFECT);

  il.dec = il.effect(unary("--"), (function(x) {
    return x - 1;
  }), il.EFFECT);

  vop = function(name, toCode, _effect) {
    var Vop, _ref19;

    if (_effect == null) {
      _effect = il.EFFECT;
    }
    Vop = (function(_super) {
      __extends(Vop, _super);

      function Vop() {
        _ref19 = Vop.__super__.constructor.apply(this, arguments);
        return _ref19;
      }

      Vop.prototype.toCode = toCode;

      Vop.prototype._effect = _effect;

      Vop.prototype._name = name;

      return Vop;

    })(VirtualOperation);
    return function() {
      var args;

      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return new Vop(args);
    };
  };

  vop2 = function(name, toCode, _effect) {
    var Vop, _ref19;

    if (_effect == null) {
      _effect = il.EFFECT;
    }
    Vop = (function(_super) {
      __extends(Vop, _super);

      function Vop() {
        _ref19 = Vop.__super__.constructor.apply(this, arguments);
        return _ref19;
      }

      Vop.prototype.toCode = toCode;

      Vop.prototype._effect = _effect;

      Vop.prototype._name = name;

      Vop.prototype.isStatement = function() {
        return true;
      };

      return Vop;

    })(VirtualOperation);
    return function() {
      var args;

      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return new Vop(args);
    };
  };

  il.attr = vop('attr', (function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ")." + (compiler.toCode(args[1]));
  }), il.PURE);

  il.nonlocal = function(vari) {
    return new NonlocalDecl(vari.name);
  };

  il.local = function(vari) {
    return new LocalDecl(vari.name);
  };

  il.vardecl = vop('vardecl', function(compiler) {
    var args, e;

    args = this.args;
    return "var " + (((function() {
      var _i, _len, _results;

      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        e = args[_i];
        _results.push(compiler.toCode(e));
      }
      return _results;
    })()).join(', '));
  });

  il.array = vop('array', function(compiler) {
    var args, e;

    args = this.args;
    return "[" + (((function() {
      var _i, _len, _results;

      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        e = args[_i];
        _results.push(compiler.toCode(e));
      }
      return _results;
    })()).join(', ')) + "]";
  });

  il.suffixinc = vop('suffixdec', function(compiler) {
    var args;

    args = this.args;
    return "" + (compiler.toCode(args[0])) + "++";
  });

  il.suffixdec = vop('suffixdec', function(compiler) {
    var args;

    args = this.args;
    return "" + (compiler.toCode(args[0])) + "--";
  });

  il.catches = il.usernonlocalattr('solver.catches');

  il.pushCatch = vop('pushCatch', function(compiler) {
    var args;

    args = this.args;
    return "solver.pushCatch(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  });

  il.popCatch = vop('popCatch', function(compiler) {
    var args;

    args = this.args;
    return "solver.popCatch(" + (compiler.toCode(args[0])) + ")";
  });

  il.findCatch = vop('findCatch', (function(compiler) {
    var args;

    args = this.args;
    return "solver.findCatch(" + (compiler.toCode(args[0])) + ")";
  }), il.PURE);

  il.fake = vop('fake', function(compiler) {
    var args;

    args = this.args;
    return "solver.fake(" + (compiler.toCode(args[0])) + ")";
  }).apply([]);

  il.restore = vop('restore', function(compiler) {
    var args;

    args = this.args;
    return "solver.restore(" + (compiler.toCode(args[0])) + ")";
  });

  il.getvalue = vop('getvalue', (function(compiler) {
    var args;

    args = this.args;
    return "solver.trail.getvalue(" + (compiler.toCode(args[0])) + ")";
  }), il.PURE);

  il.list = vop('list', (function(compiler) {
    var a, args;

    args = this.args;
    return "[" + (((function() {
      var _i, _len, _results;

      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        a = args[_i];
        _results.push(compiler.toCode(a));
      }
      return _results;
    })()).join(', ')) + "]";
  }), il.PURE);

  il.length = vop('length', (function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ").length";
  }), il.PURE);

  il.index = vop('index', (function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ")[" + (compiler.toCode(args[1])) + "]";
  }), il.PURE);

  il.slice = vop('slice', (function(compiler) {
    var args;

    args = this.args;
    return "" + (compiler.toCode(args[0])) + ".slice(" + (compiler.toCode(args[1])) + ", " + (compiler.toCode(args[2])) + ")";
  }), il.PURE);

  il.push = vop('push', function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ").push(" + (compiler.toCode(args[1])) + ")";
  });

  il.pop = vop('pop', function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ").pop()";
  });

  il.concat = vop('concat', (function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ").concat(" + (compiler.toCode(args[1])) + ")";
  }), il.PURE);

  il["instanceof"] = vop('instanceof', (function(compiler) {
    var args;

    args = this.args;
    return "(" + (compiler.toCode(args[0])) + ") instanceof (" + (compiler.toCode(args[1])) + ")";
  }), il.PURE);

  il.run = vop('run', function(compiler) {
    var args;

    args = this.args;
    return "solver.run(" + (compiler.toCode(args[0])) + ")";
  });

  il["new"] = vop('new', function(compiler) {
    var args;

    args = this.args;
    return "new " + (compiler.toCode(args[0]));
  });

  il.evalexpr = vop('evalexpr', function(compiler) {
    var args;

    args = this.args;
    return "solve(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  });

  il.require = vop('require', function(compiler) {
    var args;

    args = this.args;
    return "require(" + (compiler.toCode(args[0])) + ")";
  });

  il.newLogicVar = vop('newLogicVar', (function(compiler) {
    var args;

    args = this.args;
    return "new Var(" + (compiler.toCode(args[0])) + ")";
  }), il.PURE);

  il.newDummyVar = vop('newDummyVar', (function(compiler) {
    var args;

    args = this.args;
    return "new DummyVar(" + (compiler.toCode(args[0])) + ")";
  }), il.PURE);

  il.unify = vop('unify', function(compiler) {
    var args;

    args = this.args;
    return "solver.trail.unify(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  });

  il.bind = vop('bind', function(compiler) {
    var args;

    args = this.args;
    return "" + (compiler.toCode(args[0])) + ".bind(" + (compiler.toCode(args[1])) + ", solver.trail)";
  });

  il.solver = il.usernonlocal('solver');

  il.undotrail = vop('undotrail', function(compiler) {
    var args;

    args = this.args;
    return "" + (compiler.toCode(args[0])) + ".undo()";
  });

  il.failcont = il.usernonlocalattr('solver.failcont');

  il.setfailcont = function(cont) {
    return il.assign(il.failcont, cont);
  };

  il.setcutcont = function(cont) {
    return il.assign(il.cutcont, cont);
  };

  il.appendFailcont = vop('appendFailcont', function(compiler) {
    var args;

    args = this.args;
    return "solver.appendFailcont(" + (compiler.toCode(args[0])) + ")";
  });

  il.cutcont = il.usernonlocalattr('solver.cutcont');

  il.state = il.usernonlocalattr('solver.state');

  il.setstate = function(state) {
    return il.assign(il.state, state);
  };

  il.trail = il.usernonlocalattr('solver.trail');

  il.newTrail = vop('newTrail', function(compiler) {
    var args;

    args = this.args;
    return "new Trail()";
  })();

  il.settrail = function(trail) {
    return il.assign(il.trail, trail);
  };

  il.char = vop('char', (function(compiler) {
    var args;

    args = this.args;
    return "parser.char(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.followChars = vop('followChars', (function(compiler) {
    var args;

    args = this.args;
    return "parser.followChars(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.notFollowChars = vop('notFollowChars', (function(compiler) {
    var args;

    args = this.args;
    return "parser.notFollowChars(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.charWhen = vop('charWhen', (function(compiler) {
    var args;

    args = this.args;
    return "parser.charWhen(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.spaces = vop('spaces', (function(compiler) {
    var args;

    args = this.args;
    return "parser.spaces(" + (compiler.toCode(args[0])) + ")";
  }), il.EFFECT);

  il.spaces0 = vop('spaces0', (function(compiler) {
    var args;

    args = this.args;
    return "parser.spaces0(" + (compiler.toCode(args[0])) + ")";
  }), il.EFFECT);

  il.stringWhile = vop('stringWhile', (function(compiler) {
    var args;

    args = this.args;
    return "parser.stringWhile(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.stringWhile0 = vop('stringWhile0', (function(compiler) {
    var args;

    args = this.args;
    return "parser.stringWhile0(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.number = vop('number', (function(compiler) {
    var args;

    args = this.args;
    return "parser.number(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.literal = vop('literal', (function(compiler) {
    var args;

    args = this.args;
    return "parser.literal(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.followLiteral = vop('followLiteral', (function(compiler) {
    var args;

    args = this.args;
    return "parser.followLiteral(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.notFollowLiteral = vop('notFollowLiteral', (function(compiler) {
    var args;

    args = this.args;
    return "parser.notFollowLiteral(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.quoteString = vop('quoteString', (function(compiler) {
    var args;

    args = this.args;
    return "parser.quoteString(" + (compiler.toCode(args[0])) + ", " + (compiler.toCode(args[1])) + ")";
  }), il.EFFECT);

  il.fun = function(f) {
    return new Fun(f);
  };

  il.let_ = function() {
    var bindings, body, i, params, values, _i, _ref19;

    bindings = arguments[0], body = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    params = [];
    values = [];
    for (i = _i = 0, _ref19 = bindings.length; _i < _ref19; i = _i += 2) {
      params.push(bindings[i]);
      values.push(bindings[i + 1]);
    }
    return new Apply(il.lamda.apply(il, [params].concat(__slice.call(body))), values);
  };

  il.iff = function() {
    var clauses, else_, length, _i;

    clauses = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), else_ = arguments[_i++];
    length = clauses.length;
    if (length === 2) {
      return il.if_(clauses[0], clauses[1], else_);
    } else {
      return il.if_(clauses[0], clauses[1], il.iff.apply(il, __slice.call(clauses.slice(2, length)).concat([else_])));
    }
  };

  il.idcont = (function() {
    var v;

    v = il.internallocal('v');
    return new IdCont(v, v);
  })();

  il.excludes = ['evalexpr', 'failcont', 'run', 'getvalue', 'fake', 'findCatch', 'popCatch', 'pushCatch', 'protect', 'suffixinc', 'suffixdec', 'dec', 'inc', 'unify', 'bind', 'undotrail', 'newTrail', 'newLogicVar', 'char', 'followChars', 'notFollowChars', 'charWhen', 'stringWhile', 'stringWhile0', 'number', 'literal', 'followLiteral', 'quoteString'];

  augmentOperators = {
    add: il.addassign,
    sub: il.subassign,
    mul: il.mulassign,
    div: il.divassign,
    mod: il.modassign,
    'and_': il.andassign,
    'or_': il.orassign,
    bitand: il.bitandassign,
    bitor: il.bitorassign,
    bitxor: il.bitxorassign,
    lshift: il.lshiftassign,
    rshift: il.rshiftassign
  };

}).call(this);

/*
//@ sourceMappingURL=interlang.map
*/
